<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cute Chat ðŸ’•</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App, Firestore & Storage via CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <!-- Canvas-Confetti for â€œloveâ€ bursts -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    /* Gallery grid behind UI */
    #bg-gallery {
      position: fixed; inset: 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px,1fr));
      grid-auto-rows: 120px;
      gap: 4px;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
      opacity: 0.3;
    }
    #bg-gallery img {
      width: 100%; height: 100%; object-fit: cover;
    }
    /* Bring chat UI above gallery */
    #app-content { position: relative; z-index: 1; }
  </style>
</head>
<body>
  <!-- 1) Background gallery -->
  <div id="bg-gallery"></div>

  <div id="app-content" class="flex flex-col h-screen bg-pink-50">
    <header class="bg-pink-300 p-4 flex items-center justify-between text-white">
      <h1 class="text-2xl font-bold flex-1 text-center">Cute Chat ðŸ’•</h1>
      <div class="flex items-center space-x-2">
        <button id="clear-chat-btn"
                class="bg-red-400 hover:bg-red-500 text-white px-3 py-1 rounded-full text-sm">
          Clear All
        </button>
        <button id="upload-bg-btn"
                class="bg-white text-pink-500 px-3 py-1 rounded-full text-sm hover:bg-pink-50">
          Add Photo
        </button>
        <input type="file" id="bg-input" accept="image/*" class="hidden" />
      </div>
    </header>

    <div id="chat-window" class="flex-1 overflow-y-auto p-4"></div>
    <div id="typing-indicator" class="px-4 text-gray-600 text-sm h-6"></div>

    <form id="chat-form" class="flex p-4 bg-white border-t border-pink-200">
      <input id="chat-input"
             class="flex-1 p-2 rounded-full border border-pink-300 focus:outline-none"
             placeholder="Type your messageâ€¦" autocomplete="off"/>
      <button type="submit"
              class="ml-2 px-4 rounded-full bg-pink-400 text-white font-semibold">
        Send
      </button>
    </form>
  </div>

  <script>
    // --- 1) Initialize Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_LU2HJW9ppDRynAdDzoElD7B0h4YrC-M",
      authDomain: "chat-linh-tinh.firebaseapp.com",
      projectId: "chat-linh-tinh",
      storageBucket: "chat-linh-tinh.firebasestorage.app",
      messagingSenderId: "942886320131",
      appId: "1:942886320131:web:48a40f121339205eeaf636",
      measurementId: "G-18EQZM2TY5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const FieldValue = firebase.firestore.FieldValue;

    // --- 2) Prompt for your name ---
    let user;
    while (true) {
      user = prompt("What is your name? (Only â€œTÃºnâ€ or â€œLinhâ€ allowed)");
      if (user === "TÃºn" || user === "Linh") break;
      alert("Sorry, only TÃºn or Linh can chat here!");
    }

    // --- 3) Notification permission ---
    if ("Notification" in window) {
      Notification.requestPermission().then(p => console.log("Notif perm:", p));
    }

    // --- 4) Typing indicator ---
    const typingRef = db.collection("status").doc("typing");
    typingRef.set({ [user]: false }, { merge: true });
    const chatInput = document.getElementById("chat-input");
    let typingTimeout;
    chatInput.addEventListener("input", () => {
      typingRef.set({ [user]: true }, { merge: true });
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => typingRef.update({ [user]: false }), 1000);
    });
    typingRef.onSnapshot(doc => {
      const data  = doc.data() || {};
      const other = user === "TÃºn" ? "Linh" : "TÃºn";
      document.getElementById("typing-indicator").textContent =
        data[other] ? "Typingâ€¦" : "";
    });

    // --- 5) Send & Clear helpers ---
    async function sendMessage(text) {
      await db.collection("messages").add({
        text, user,
        createdAt: FieldValue.serverTimestamp(),
        seenBy: []
      });
    }
    async function clearChat() {
      if (!confirm("Delete every message?")) return;
      const snap = await db.collection("messages").get();
      const batch = db.batch();
      snap.forEach(d => batch.delete(d.ref));
      await batch.commit();
    }
    document.getElementById("clear-chat-btn")
            .addEventListener("click", clearChat);

    // --- 6) Gallery: upload to Storage + record URL in Firestore ---
    const bgInput     = document.getElementById("bg-input");
    const uploadBtn   = document.getElementById("upload-bg-btn");
    const galleryEl   = document.getElementById("bg-gallery");
    const galleryCol  = db.collection("gallery");

    // listen for gallery changes
    galleryCol.orderBy("createdAt","asc")
      .onSnapshot(snap => {
        galleryEl.innerHTML = "";
        snap.forEach(doc => {
          const url = doc.data().url;
          const img = document.createElement("img");
          img.src = url;
          galleryEl.appendChild(img);
        });
      });

    // on file pick â†’ upload to Storage â†’ save downloadURL in Firestore
    uploadBtn.addEventListener("click", () => bgInput.click());
    bgInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      // unique path
      const path = `gallery/${Date.now()}_${file.name}`;
      const ref  = storage.ref(path);
      ref.put(file)
        .then(() => ref.getDownloadURL())
        .then(url => galleryCol.add({
          url,
          createdAt: FieldValue.serverTimestamp()
        }))
        .catch(console.error);
    });

    // --- 7) Chat listener with notifications & confetti ---
    const chatWindow = document.getElementById("chat-window");
    let initialLoad  = true;

    function renderBubble(doc) {
      const { text, user: u, createdAt, seenBy=[] } = doc.data();
      if (u!==user && !seenBy.includes(user)) {
        doc.ref.update({ seenBy: FieldValue.arrayUnion(user) });
      }
      const d       = createdAt ? createdAt.toDate() : new Date();
      const dateStr = d.toLocaleDateString("en-GB",{day:'2-digit',month:'2-digit'});
      const timeStr = d.toLocaleTimeString("en-GB",{hour:'2-digit',minute:'2-digit'});
      const dateTime= `${dateStr} ${timeStr}`;
      const side = u===user ? "justify-end":"justify-start";
      const bg   = u===user ? "bg-pink-200":"bg-white shadow";
      const other= user==="TÃºn" ? "Linh":"TÃºn";
      const seen = (u===user && seenBy.includes(other))
                 ? `<span class="text-xs text-blue-500 ml-1">âœ“</span>` : "";

      const el = document.createElement("div");
      el.className = `my-2 flex ${side}`;
      el.innerHTML = `
        <div class="max-w-xs p-3 rounded-2xl ${bg}">
          <div class="flex items-baseline justify-between">
            <span class="text-sm font-medium">${u}</span>
            <span class="text-xs text-gray-600 ml-2">${dateTime}</span>
            ${seen}
          </div>
          <p class="mt-1">${text}</p>
        </div>`;
      chatWindow.appendChild(el);
    }

    db.collection("messages")
      .orderBy("createdAt","asc")
      .onSnapshot(snap => {
        if (initialLoad) {
          chatWindow.innerHTML = "";
          snap.forEach(renderBubble);
          chatWindow.scrollTop = chatWindow.scrollHeight;
          initialLoad = false;
          return;
        }
        snap.docChanges().forEach(change => {
          if (change.type==="added") {
            const { text, user: u } = change.doc.data();
            if (u!==user && Notification.permission==="granted") {
              new Notification(`${u} says:`,{
                body:text.length>50?text.slice(0,47)+"â€¦":text
              });
            }
            if (text.toLowerCase().includes("love")) {
              confetti({particleCount:100,spread:60,origin:{y:0.6}});
            }
          }
        });
        chatWindow.innerHTML = "";
        snap.forEach(renderBubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      });

    // --- 8) Form submit + self â€œloveâ€ confetti ---
    document.getElementById("chat-form")
      .addEventListener("submit", e => {
        e.preventDefault();
        const txt = chatInput.value.trim();
        if (!txt) return;
        sendMessage(txt);
        if (txt.toLowerCase().includes("love")) {
          confetti({particleCount:100,spread:60,origin:{y:0.6}});
        }
        chatInput.value = "";
      });
  </script>
</body>
</html>
