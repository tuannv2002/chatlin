<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cute Chat ðŸ’•</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App & Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <!-- Emoji picker -->
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.js"></script>
</head>
<body class="flex flex-col h-screen bg-pink-50">
  <header class="bg-pink-300 p-4 flex items-center justify-between text-white">
    <h1 class="text-2xl font-bold flex-1 text-center">Cute Chat ðŸ’•</h1>
    <button id="clear-chat-btn" class="ml-4 bg-red-400 hover:bg-red-500 text-white px-3 py-1 rounded-full text-sm">
      Clear All
    </button>
  </header>

  <div id="chat-window" class="flex-1 overflow-y-auto p-4"></div>
  <div id="typing-indicator" class="px-4 text-gray-600 text-sm h-6"></div>

  <form id="chat-form" class="flex p-4 bg-white border-t border-pink-200">
    <button id="emoji-btn" type="button" class="mr-2 text-2xl focus:outline-none">ðŸ˜Š</button>
    <input id="chat-input" class="flex-1 p-2 rounded-full border border-pink-300 focus:outline-none"
           placeholder="Type your messageâ€¦" autocomplete="off"/>
    <button type="submit" class="ml-2 px-4 rounded-full bg-pink-400 text-white font-semibold">
      Send
    </button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 1) Firebase init
      const firebaseConfig = {
        apiKey: "AIzaSyA_LU2HJW9ppDRynAdDzoElD7B0h4YrC-M",
        authDomain: "chat-linh-tinh.firebaseapp.com",
        projectId: "chat-linh-tinh",
        storageBucket: "chat-linh-tinh.firebasestorage.app",
        messagingSenderId: "942886320131",
        appId: "1:942886320131:web:48a40f121339205eeaf636",
        measurementId: "G-18EQZM2TY5"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const FieldValue = firebase.firestore.FieldValue;

      // 2) Name prompt
      let user;
      while (true) {
        user = prompt("What is your name? (Only â€œTÃºnâ€ or â€œLinhâ€ allowed)");
        if (user === "TÃºn" || user === "Linh") break;
        alert("Sorry, only TÃºn or Linh can chat here!");
      }
      console.log("Logged in as:", user);

      // 3) Typing indicator setup
      const typingRef = db.collection("status").doc("typing");
      typingRef.set({ [user]: false }, { merge: true });

      const chatInput = document.getElementById("chat-input");
      const typingIndicator = document.getElementById("typing-indicator");
      let typingTimeout;
      chatInput.addEventListener("input", () => {
        typingRef.set({ [user]: true }, { merge: true });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          typingRef.update({ [user]: false });
        }, 1000);
      });
      typingRef.onSnapshot(doc => {
        const data = doc.data() || {};
        const other = user === "TÃºn" ? "Linh" : "TÃºn";
        typingIndicator.textContent = data[other] ? "Typingâ€¦" : "";
      });

      // 4) Emoji picker
      const picker = new EmojiButton({ position: 'top-end', zIndex: 10000 });
      picker.on('emoji', emoji => {
        const start = chatInput.selectionStart;
        const end   = chatInput.selectionEnd;
        chatInput.value = chatInput.value.slice(0, start) + emoji + chatInput.value.slice(end);
        chatInput.selectionStart = chatInput.selectionEnd = start + emoji.length;
        chatInput.focus();
      });
      document.getElementById("emoji-btn")
              .addEventListener('click', () => picker.togglePicker(document.getElementById("emoji-btn")));

      // 5) Send helper
      async function sendMessage(text) {
        console.log("Sending message:", text);
        await db.collection("messages").add({
          text,
          user,
          createdAt: FieldValue.serverTimestamp(),
          seenBy: []
        });
      }

      // 6) Clear chat
      async function clearChat() {
        if (!confirm("Are you sure you want to delete every message?")) return;
        const snap = await db.collection("messages").get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        console.log("Chat cleared");
      }
      document.getElementById("clear-chat-btn")
              .addEventListener("click", clearChat);

      // 7) Render messages
      const chatWindow = document.getElementById("chat-window");
      db.collection("messages")
        .orderBy("createdAt", "asc")
        .onSnapshot(snapshot => {
          chatWindow.innerHTML = "";
          snapshot.forEach(doc => {
            const { text, user: u, createdAt, seenBy = [] } = doc.data();

            // mark seen
            if (u !== user && !seenBy.includes(user)) {
              doc.ref.update({ seenBy: FieldValue.arrayUnion(user) });
            }

            // time formatting
            const d = createdAt ? createdAt.toDate() : new Date();
            const dateStr = d.toLocaleDateString("en-GB", { day:'2-digit', month:'2-digit' });
            const timeStr = d.toLocaleTimeString("en-GB", { hour:'2-digit', minute:'2-digit' });
            const dateTime = `${dateStr} ${timeStr}`;

            const side = u === user ? "justify-end" : "justify-start";
            const bg = u === user ? "bg-pink-200" : "bg-white shadow";
            const other = user === "TÃºn" ? "Linh" : "TÃºn";
            const seenIcon = (u===user && seenBy.includes(other)) ? `<span class="text-xs text-blue-500 ml-1">âœ“</span>` : "";

            const msgEl = document.createElement("div");
            msgEl.className = `my-2 flex ${side}`;
            msgEl.innerHTML = `
              <div class="max-w-xs p-3 rounded-2xl ${bg}">
                <div class="flex items-baseline justify-between">
                  <span class="text-sm font-medium">${u}</span>
                  <span class="text-xs text-gray-600 ml-2">${dateTime}</span>
                  ${seenIcon}
                </div>
                <p class="mt-1">${text}</p>
              </div>`;
            chatWindow.appendChild(msgEl);
          });
          chatWindow.scrollTop = chatWindow.scrollHeight;
        });

      // 8) Form submit
      document.getElementById("chat-form")
        .addEventListener("submit", e => {
          e.preventDefault();
          const txt = chatInput.value.trim();
          if (!txt) return;
          sendMessage(txt).catch(err => console.error("Send failed:", err));
          chatInput.value = "";
        });
    });
  </script>
</body>
</html>
