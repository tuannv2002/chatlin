<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cute Chat üíï</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App & Firestore via CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body class="flex flex-col h-screen bg-pink-50">
  <header class="bg-pink-300 p-4 flex items-center justify-between text-white">
    <h1 class="text-2xl font-bold text-center flex-1">Cute Chat üíï</h1>
    <button
      id="clear-chat-btn"
      class="ml-4 bg-red-400 hover:bg-red-500 text-white px-3 py-1 rounded-full text-sm"
    >
      Clear All
    </button>
  </header>

  <div id="chat-window" class="flex-1 overflow-y-auto p-4"></div>
  <!-- Typing indicator below the messages -->
  <div id="typing-indicator" class="px-4 text-gray-600 text-sm h-6"></div>

  <form id="chat-form" class="flex p-4 bg-white border-t border-pink-200">
    <input
      id="chat-input"
      class="flex-1 p-2 rounded-full border border-pink-300 focus:outline-none"
      placeholder="Type your message‚Ä¶"
      autocomplete="off"
    />
    <button
      type="submit"
      class="ml-2 px-4 rounded-full bg-pink-400 text-white font-semibold"
    >
      Send
    </button>
  </form>

  <script>
    // 1) Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA_LU2HJW9ppDRynAdDzoElD7B0h4YrC-M",
      authDomain: "chat-linh-tinh.firebaseapp.com",
      projectId: "chat-linh-tinh",
      storageBucket: "chat-linh-tinh.firebasestorage.app",
      messagingSenderId: "942886320131",
      appId: "1:942886320131:web:48a40f121339205eeaf636",
      measurementId: "G-18EQZM2TY5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const FieldValue = firebase.firestore.FieldValue;

    // 2) Prompt for your name (only ‚ÄúT√∫n‚Äù or ‚ÄúLinh‚Äù allowed)
    let user;
    while (true) {
      user = prompt("What is your name? (Only ‚ÄúT√∫n‚Äù or ‚ÄúLinh‚Äù allowed)");
      if (user === "T√∫n" || user === "Linh") break;
      alert("Sorry, only T√∫n or Linh can chat here!");
    }

    // 3) Prepare typing-status document
    const typingRef = db.collection("status").doc("typing");
    // ensure our field exists
    typingRef.set({ [user]: false }, { merge: true });

    // 4) Handle ‚Äútyping‚Ä¶‚Äù indicator
    const chatInput = document.getElementById("chat-input");
    let typingTimeout;
    chatInput.addEventListener("input", () => {
      // set our typing flag true
      typingRef.set({ [user]: true }, { merge: true });
      clearTimeout(typingTimeout);
      // clear after 1s of no input
      typingTimeout = setTimeout(() => {
        typingRef.update({ [user]: false });
      }, 1000);
    });

    // listen for other user typing
    typingRef.onSnapshot(doc => {
      const data = doc.data() || {};
      const other = user === "T√∫n" ? "Linh" : "T√∫n";
      const indicator = document.getElementById("typing-indicator");
      if (data[other]) {
        indicator.textContent = "Typing‚Ä¶";
      } else {
        indicator.textContent = "";
      }
    });

    // 5) Helper to send a message
    async function sendMessage(text) {
      await db.collection("messages").add({
        text,
        user,
        createdAt: FieldValue.serverTimestamp(),
        seenBy: []  // initialize empty
      });
    }

    // 6) Helper to clear all messages
    async function clearChat() {
      if (!confirm("Are you sure you want to delete every message?")) return;
      const snap = await db.collection("messages").get();
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    }
    document.getElementById("clear-chat-btn")
      .addEventListener("click", clearChat);

    // 7) Listen for new messages & render with ‚Äúseen‚Äù and date/time
    const chatWindow = document.getElementById("chat-window");
    db.collection("messages")
      .orderBy("createdAt", "asc")
      .onSnapshot(snapshot => {
        chatWindow.innerHTML = "";

        snapshot.forEach(doc => {
          const data = doc.data();
          const { text, user: u, createdAt, seenBy = [] } = data;

          // mark messages from the other user as ‚Äúseen‚Äù
          if (u !== user && !seenBy.includes(user)) {
            doc.ref.update({
              seenBy: FieldValue.arrayUnion(user)
            });
          }

          // build date/time label
          const dateObj = createdAt ? createdAt.toDate() : new Date();
          const dateString = dateObj.toLocaleDateString("en-GB", {
            day: "2-digit", month: "2-digit"
          });
          const timeString = dateObj.toLocaleTimeString("en-GB", {
            hour: "2-digit", minute: "2-digit"
          });
          const dateTime = `${dateString} ${timeString}`;

          // determine bubble style
          const side = u === user ? "justify-end" : "justify-start";
          const bg = u === user ? "bg-pink-200" : "bg-white shadow";

          // seen indicator for our own messages
          const other = user === "T√∫n" ? "Linh" : "T√∫n";
          const seenIndicator =
            (u === user && seenBy.includes(other))
              ? `<span class="text-xs text-blue-500 ml-1">‚úì</span>`
              : "";

          // render bubble
          const msgEl = document.createElement("div");
          msgEl.className = `my-2 flex ${side}`;
          msgEl.innerHTML = `
            <div class="max-w-xs p-3 rounded-2xl ${bg}">
              <div class="flex items-baseline justify-between">
                <span class="text-sm font-medium">${u}</span>
                <span class="text-xs text-gray-600 ml-2">${dateTime}</span>
                ${seenIndicator}
              </div>
              <p class="mt-1">${text}</p>
            </div>`;
          chatWindow.appendChild(msgEl);
        });

        chatWindow.scrollTop = chatWindow.scrollHeight;
      });

    // 8) Hook up the form submission
    document.getElementById("chat-form")
      .addEventListener("submit", e => {
        e.preventDefault();
        const input = document.getElementById("chat-input");
        const txt = input.value.trim();
        if (txt) {
          sendMessage(txt);
          input.value = "";
        }
      });
  </script>
</body>
</html>
